{% extends "base.html" %}

{% block content %}
<div class="matches-container">
    <h1 style="text-align: center; margin-bottom: 2rem;">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</h1>

    {% if matches %}
    {% for match in matches %}
    <div class="match-card" id="match-{{ match.id }}"
        style="background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">

        <!-- Scoreboard Header -->
        <div class="scoreboard"
            style="text-align: center; background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; position: relative;">
            <button class="btn btn-share btn-sm share-match-btn" data-target="#match-{{ match.id }}"
                title="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©"
                style="position: absolute; top: 10px; right: 80px; font-size: 0.85rem; border: 1px solid white; color: white;">
                Ù…Ø´Ø§Ø±ÙƒØ© ğŸ“¤ğŸ“¸
            </button>
            <span style="position: absolute; top: 10px; right: 15px; font-size: 0.85rem; color: #bdc3c7;">#{{ match.id
                }}</span>
            <span style="position: absolute; top: 10px; left: 15px; font-size: 0.85rem; color: #bdc3c7;">{{
                match.date.strftime('%Y-%m-%d %H:%M') }}</span>
            <button class="delete-match-btn" data-match-id="{{ match.id }}" title="Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©"
                style="position: absolute; bottom: 10px; right: 15px; background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #e74c3c; z-index: 10;">
                ğŸ—‘ï¸
            </button>

            <h2
                style="margin: 0; display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
                <span style="flex: 1; text-align: left; color: #3498db; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">{{
                    match.team_a_name }}</span>
                <span
                    style="font-size: 2.5rem; background: rgba(255,255,255,0.1); padding: 5px 20px; border-radius: 8px;">
                    <span style="color: #3498db">{{ match.team_a_score }}</span>
                    <span style="color: #666; font-size: 1.5rem;">-</span>
                    <span style="color: #e67e22">{{ match.team_b_score }}</span>
                </span>
                <span style="flex: 1; text-align: right; color: #e67e22; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">{{
                    match.team_b_name }}</span>
            </h2>
        </div>

        <!-- Teams Tables -->
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">

            <!-- Team A Stats -->
            <div style="flex: 1; min-width: 300px;">
                <h4 style="color: #3498db; margin-bottom: 10px; border-bottom: 2px solid #3498db; padding-bottom: 5px;">
                    ØªØ´ÙƒÙŠÙ„Ø© {{ match.team_a_name }}</h4>
                <div class="table-responsive">
                    <table style="width: 100%; font-size: 0.9rem;">
                        <thead style="background: #f0f8ff;">
                            <tr>
                                <th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th>
                                <th>âš½</th>
                                <th>ğŸ‘Ÿ</th>
                                <th>âœ‹</th>
                                <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in match.stats %}
                            {% if stat.team == 'A' %}
                            <tr style="border-bottom: 1px solid #eee;">
                                <td>
                                    <strong>{{ stat.player.name }}</strong>
                                    {% if stat.is_captain %}<span title="Captain">Â©ï¸</span>{% endif %}
                                    {% if stat.mvp %}<span title="MVP">â­</span>{% endif %}
                                    {% if stat.clean_sheet %}<span title="Clean Sheet">ğŸ›¡ï¸</span>{% endif %}
                                </td>
                                <td>{% if stat.goals > 0 %}{{ stat.goals }}{% else %}-{% endif %}</td>
                                <td>{% if stat.assists > 0 %}{{ stat.assists }}{% else %}-{% endif %}</td>
                                <td>{% if stat.saves > 0 %}{{ stat.saves }}{% else %}-{% endif %}</td>
                                {% if stat.is_winner %}
                                <td style="font-weight: bold; color: #27ae60;">{{ stat.points_earned }}</td>
                                {% else %}
                                <td style="font-weight: bold; color: #7f8c8d;">{{ stat.points_earned }}</td>
                                {% endif %}
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Team B Stats -->
            <div style="flex: 1; min-width: 300px;">
                <h4 style="color: #e67e22; margin-bottom: 10px; border-bottom: 2px solid #e67e22; padding-bottom: 5px;">
                    ØªØ´ÙƒÙŠÙ„Ø© {{ match.team_b_name }}</h4>
                <div class="table-responsive">
                    <table style="width: 100%; font-size: 0.9rem;">
                        <thead style="background: #fff5f0;">
                            <tr>
                                <th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th>
                                <th>âš½</th>
                                <th>ğŸ‘Ÿ</th>
                                <th>âœ‹</th>
                                <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in match.stats %}
                            {% if stat.team == 'B' %}
                            <tr style="border-bottom: 1px solid #eee;">
                                <td>
                                    <strong>{{ stat.player.name }}</strong>
                                    {% if stat.is_captain %}<span title="Captain">Â©ï¸</span>{% endif %}
                                    {% if stat.mvp %}<span title="MVP">â­</span>{% endif %}
                                    {% if stat.clean_sheet %}<span title="Clean Sheet">ğŸ›¡ï¸</span>{% endif %}
                                </td>
                                <td>{% if stat.goals > 0 %}{{ stat.goals }}{% else %}-{% endif %}</td>
                                <td>{% if stat.assists > 0 %}{{ stat.assists }}{% else %}-{% endif %}</td>
                                <td>{% if stat.saves > 0 %}{{ stat.saves }}{% else %}-{% endif %}</td>
                                {% if stat.is_winner %}
                                <td style="font-weight: bold; color: #27ae60;">{{ stat.points_earned }}</td>
                                {% else %}
                                <td style="font-weight: bold; color: #7f8c8d;">{{ stat.points_earned }}</td>
                                {% endif %}
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div> <!-- End Flex Container -->
    </div>
    {% endfor %}
    {% else %}
    <div style="text-align: center; padding: 3rem; color: #666;">
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>
    </div>
    {% endif %}
</div>

<script>
    document.querySelectorAll('.delete-match-btn').forEach(btn => {
        btn.addEventListener('click', async function () {
            const matchId = this.getAttribute('data-match-id');
            const adminPw = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©:");

            if (adminPw) {
                try {
                    const response = await fetch(`/l/{{ league.slug }}/admin/match/${matchId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ admin_password: adminPw })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        alert('âœ… ' + data.message);
                        window.location.reload();
                    } else {
                        alert('âŒ Ø®Ø·Ø£: ' + (data.detail || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                    }
                } catch (err) {
                    console.error(err);
                    alert('âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
                }
            }
        });
    });

    // Share Match Logic
    document.querySelectorAll('.share-match-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const targetId = this.getAttribute('data-target');
            const captureArea = document.querySelector(targetId);

            if (captureArea) {
                // Hide interactive buttons purely for the screenshot
                const deleteBtn = captureArea.querySelector('.delete-match-btn');
                const shareBtn = captureArea.querySelector('.share-match-btn');

                if (deleteBtn) deleteBtn.style.display = 'none';
                if (shareBtn) shareBtn.style.display = 'none';

                const isDark = document.body.classList.contains("dark-mode");
                const bgColor = isDark ? "#2a2a2a" : "#ffffff"; // matches card bg more closely

                html2canvas(captureArea, {
                    backgroundColor: bgColor,
                    scale: 2,
                    useCORS: true
                }).then(canvas => {
                    // Restore buttons
                    if (deleteBtn) deleteBtn.style.display = '';
                    if (shareBtn) shareBtn.style.display = '';

                    const image = canvas.toDataURL("image/png");
                    const link = document.createElement("a");
                    link.href = image;
                    // Extract match ID from targetId (e.g. #match-15)
                    const mId = targetId.split('-')[1];
                    link.download = `match_${mId}_{{ league.slug }}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }).catch(err => {
                    // Restore buttons in case of error too
                    if (deleteBtn) deleteBtn.style.display = '';
                    if (shareBtn) shareBtn.style.display = '';
                    console.error("Error generating screenshot: ", err);
                    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©.");
                });
            }
        });
    });
</script>
{% endblock %}