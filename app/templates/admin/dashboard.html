{% extends "base.html" %}

{% block content %}
<h1>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ù…Ø¨Ø§Ø±Ø§Ø© (Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªÙƒØªÙŠÙƒÙŠØ©)</h1>

<div class="admin-card">
    <h3>ğŸ† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ£Ø³</h3>
    <form action="/l/{{ league.slug }}/admin/cup/generate" method="POST">
        <button type="submit" class="btn-primary" style="background-color: #f39c12;">
            Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø±Ø¹Ø© Ø§Ù„ÙƒØ£Ø³ (Ø£Ø¹Ù„Ù‰ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ†)
        </button>
    </form>
    <p style="font-size: 0.9rem; margin-top: 10px;">* Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØªØ³ÙƒÙŠÙ†Ù‡Ù… ÙÙŠ Ù…ÙˆØ§Ø¬Ù‡Ø§Øª
        Ø±Ø¨Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.</p>
</div>

<div class="admin-card" style="border-right: 5px solid var(--negative-color);">
    <h3 style="color: var(--negative-color);">ğŸš¨ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
    <form action="/l/{{ league.slug }}/admin/season/end" method="POST"
        onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ØŸ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØµØ¯Ø± Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù ÙˆØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©!');">
        <input type="text" name="month_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø± (Ù…Ø«Ø§Ù„: Ø£ØºØ³Ø·Ø³ 2026)" required class="tactical-input"
            style="width: 250px; margin-left: 10px; display: inline-block;">
        <button type="submit" class="btn-primary" style="background-color: var(--negative-color);">
            Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©
        </button>
    </form>
</div>

<div class="match-form-container">
    <div style="margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;">
        <h3 style="margin-top:0;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
        <input type="password" id="admin_password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©" required
            class="tactical-input">
    </div>

    <!-- Tactical Board -->
    <div class="tactical-board" style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px;">

        <!-- Team A -->
        <div class="team-container team-a-container">
            <input type="text" id="team_a_name" value="ÙØ±ÙŠÙ‚ Ø£" class="tactical-input"
                style="font-size: 1.5rem; font-weight: bold; border: none; background: transparent; border-bottom: 2px solid var(--accent-color); margin-bottom: 15px; text-align: center; border-radius: 0;">
            <button id="add-player-a-btn" class="btn-primary"
                style="width: 100%; margin-bottom: 15px; background: var(--accent-color);">+ Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ù„Ù„ÙØ±ÙŠÙ‚</button>
            <div class="table-responsive" style="margin-bottom: 0;">
                <table style="min-width: 700px;">
                    <thead>
                        <tr>
                            <th style="min-width: 120px;">Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨</th>
                            <th>âš½ Ø£Ù‡Ø¯Ø§Ù</th>
                            <th>ğŸ‘Ÿ Ø£Ø³ÙŠØ³Øª</th>
                            <th>ğŸ§¤ Ø­Ø§Ø±Ø³ØŸ</th>
                            <th>âœ‹ ØªØµØ¯ÙŠØ§Øª</th>
                            <th>âŒ Ø¹Ù„ÙŠÙ‡</th>
                            <th>ğŸ›¡ï¸ CS</th>
                            <th>â­ MVP</th>
                            <th>Â©ï¸ ÙƒØ§Ø¨ØªÙ†</th>
                            <th>ØªØ¨Ø¯ÙŠÙ„/Ø­Ø°Ù</th>
                        </tr>
                    </thead>
                    <tbody id="team-a-body">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Team B -->
        <div class="team-container team-b-container">
            <input type="text" id="team_b_name" value="ÙØ±ÙŠÙ‚ Ø¨" class="tactical-input"
                style="font-size: 1.5rem; font-weight: bold; border: none; background: transparent; border-bottom: 2px solid #e67e22; margin-bottom: 15px; text-align: center; border-radius: 0;">
            <button id="add-player-b-btn" class="btn-primary"
                style="width: 100%; margin-bottom: 15px; background: #e67e22;">+ Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ù„Ù„ÙØ±ÙŠÙ‚</button>
            <div class="table-responsive" style="margin-bottom: 0;">
                <table style="min-width: 700px;">
                    <thead>
                        <tr>
                            <th style="min-width: 120px;">Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨</th>
                            <th>âš½ Ø£Ù‡Ø¯Ø§Ù</th>
                            <th>ğŸ‘Ÿ Ø£Ø³ÙŠØ³Øª</th>
                            <th>ğŸ§¤ Ø­Ø§Ø±Ø³ØŸ</th>
                            <th>âœ‹ ØªØµØ¯ÙŠØ§Øª</th>
                            <th>âŒ Ø¹Ù„ÙŠÙ‡</th>
                            <th>ğŸ›¡ï¸ CS</th>
                            <th>â­ MVP</th>
                            <th>Â©ï¸ ÙƒØ§Ø¨ØªÙ†</th>
                            <th>ØªØ¨Ø¯ÙŠÙ„/Ø­Ø°Ù</th>
                        </tr>
                    </thead>
                    <tbody id="team-b-body">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <button id="save-match-btn" class="btn-primary"
        style="width: 100%; padding: 15px; font-size: 1.2rem; background: var(--positive-color);">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ÙˆØ¥Ù‚Ø±Ø§Ø±
        Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
</div>

<!-- Template for a new row (hidden) -->
<template id="player-row-template">
    <tr class="player-row">
        <td data-label="Ø§Ù„Ø§Ø³Ù…">
            <input type="text" class="player-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
        </td>
        <td data-label="Ø£Ù‡Ø¯Ø§Ù">
            <input type="number" class="goals-input tactical-input" value="0" min="0"
                style="width: 50px; padding: 5px;">
        </td>
        <td data-label="Ø£Ø³ÙŠØ³Øª">
            <input type="number" class="assists-input tactical-input" value="0" min="0"
                style="width: 50px; padding: 5px;">
        </td>
        <td data-label="Ø­Ø§Ø±Ø³ØŸ">
            <input type="checkbox" class="is-gk-check">
        </td>
        <td data-label="ØªØµØ¯ÙŠØ§Øª">
            <input type="number" class="saves-input tactical-input" value="0" min="0" disabled
                style="width: 50px; padding: 5px; opacity: 0.5;">
        </td>
        <td data-label="Ø£Ù‡Ø¯Ø§Ù Ø¹Ù„ÙŠÙ‡">
            <input type="number" class="conceded-input tactical-input" value="0" min="0"
                style="width: 50px; padding: 5px;">
        </td>
        <td data-label="CS">
            <input type="checkbox" class="clean-sheet-check">
        </td>
        <td data-label="MVP">
            <input type="checkbox" class="mvp-check">
        </td>
        <td data-label="ÙƒØ§Ø¨ØªÙ† (x2)">
            <input type="checkbox" class="captain-check">
        </td>
        <td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡" style="white-space: nowrap;">
            <button class="swap-row-btn" title="Ø§Ù†Ù‚Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø±"
                style="background-color: #9b59b6; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; margin-left: 5px;">ğŸ”„</button>
            <button class="remove-row-btn" title="Ø­Ø°Ù"
                style="background-color: var(--negative-color); color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer;">X</button>
        </td>
    </tr>
</template>

<script>
    const teamABody = document.getElementById('team-a-body');
    const teamBBody = document.getElementById('team-b-body');
    const template = document.getElementById('player-row-template');

    // Function to add a new row
    function addPlayerRow(targetBody) {
        const clone = template.content.cloneNode(true);
        const tr = clone.querySelector('tr');

        // Remove
        clone.querySelector('.remove-row-btn').addEventListener('click', function () {
            this.closest('tr').remove();
        });

        // Swap
        clone.querySelector('.swap-row-btn').addEventListener('click', function () {
            const currentRow = this.closest('tr');
            if (currentRow.parentElement.id === 'team-a-body') {
                teamBBody.appendChild(currentRow);
            } else {
                teamABody.appendChild(currentRow);
            }
        });

        // GK logic
        const gkCheck = clone.querySelector('.is-gk-check');
        const savesInput = clone.querySelector('.saves-input');

        gkCheck.addEventListener('change', function () {
            savesInput.disabled = !this.checked;
            if (this.checked) {
                savesInput.style.backgroundColor = 'white';
                savesInput.focus();
            } else {
                savesInput.style.backgroundColor = '#f0f0f0';
                savesInput.value = 0;
            }
        });

        targetBody.appendChild(clone);
    }

    // Add 5 initial rows for each team
    for (let i = 0; i < 5; i++) {
        addPlayerRow(teamABody);
        addPlayerRow(teamBBody);
    }

    document.getElementById('add-player-a-btn').addEventListener('click', () => addPlayerRow(teamABody));
    document.getElementById('add-player-b-btn').addEventListener('click', () => addPlayerRow(teamBBody));

    document.getElementById('save-match-btn').addEventListener('click', async () => {
        const adminPassword = document.getElementById('admin_password').value;
        if (!adminPassword) {
            alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¯ÙˆØ±ÙŠ.');
            return;
        }

        const teamAName = document.getElementById('team_a_name').value.trim() || 'ÙØ±ÙŠÙ‚ Ø£';
        const teamBName = document.getElementById('team_b_name').value.trim() || 'ÙØ±ÙŠÙ‚ Ø¨';
        const stats = [];

        // Parse Team A
        const rowsA = teamABody.querySelectorAll('.player-row');
        rowsA.forEach(row => collectRowStats(row, 'A', stats));

        // Parse Team B
        const rowsB = teamBBody.querySelectorAll('.player-row');
        rowsB.forEach(row => collectRowStats(row, 'B', stats));

        if (stats.length === 0) {
            alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
            return;
        }

        const payload = {
            team_a_name: teamAName,
            team_b_name: teamBName,
            stats: stats,
            admin_password: adminPassword
        };

        try {
            const response = await fetch('/l/{{ league.slug }}/admin/match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚!');
                window.location.reload();
            } else {
                const errorData = await response.json();
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (errorData.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
        }
    });

    function collectRowStats(row, teamIdentifier, statsArray) {
        const nameInput = row.querySelector('.player-name-input');
        const name = nameInput.value.trim();

        if (name) {
            statsArray.push({
                player_name: name,
                team: teamIdentifier,
                goals: parseInt(row.querySelector('.goals-input').value) || 0,
                assists: parseInt(row.querySelector('.assists-input').value) || 0,
                saves: parseInt(row.querySelector('.saves-input').value) || 0,
                goals_conceded: parseInt(row.querySelector('.conceded-input').value) || 0,
                is_gk: row.querySelector('.is-gk-check').checked,
                clean_sheet: row.querySelector('.clean-sheet-check').checked,
                mvp: row.querySelector('.mvp-check').checked,
                is_captain: row.querySelector('.captain-check').checked
            });
        }
    }
</script>
{% endblock %}