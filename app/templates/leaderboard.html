{% extends "base.html" %}

{% block content %}
<h1>ğŸ† ØªØ±ØªÙŠØ¨ Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„</h1>

<div style="text-align: center; margin-bottom: 20px;">
    <button id="share-leaderboard" class="btn btn-share">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØ±ØªÙŠØ¨ ğŸ“¤ğŸ“¸</button>
</div>

<div id="capture-area" style="padding: 10px; border-radius: 8px;">

    <!-- Dynamic Banners -->
    <div class="banners-container" style="margin-bottom: 20px;">
        {% if latest_hof %}
        <div class="banner-card"
            style="background: linear-gradient(135deg, #f1c40f, #e67e22); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; text-align: center; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            ğŸŒŸ Ø¨Ø·Ù„ Ø´Ù‡Ø± {{ latest_hof.month_year }}: {{ latest_hof.player.name }} ({{ latest_hof.points_scored }} Ù†Ù‚Ø·Ø©)
            ğŸŒŸ
        </div>
        {% endif %}

        {% if next_cup %}
        <div class="banner-card"
            style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; text-align: center; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            ğŸ† Ù…ÙˆØ¹Ø¯ Ø§Ù„ÙƒØ£Ø³ Ø§Ù„Ù‚Ø§Ø¯Ù…: {{ next_cup.player1.name }} ğŸ†š {{ next_cup.player2.name }} ğŸ†
        </div>
        {% endif %}
    </div>

    {% if not players %}
    <div class="empty-state">
        <div class="icon">ğŸœï¸</div>
        <h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø¹Ø¯</h3>
        <p>Ø§Ù„Ø³Ø§Ø­Ø© Ø®Ø§Ù„ÙŠØ©! Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„ Ù…Ø¨Ø§Ø±Ø§Ø© Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„ØªØ¨Ø¯Ø£ Ø§Ù„Ø¥Ø«Ø§Ø±Ø©.</p>
    </div>
    {% else %}
    <!-- Leaderboard Category Tabs -->
    <div class="tabs-container"
        style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
        <button class="tab-btn active" data-sort="points">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù…</button>
        <button class="tab-btn" data-sort="goals">Ø§Ù„Ù‡Ø¯Ø§ÙÙŠÙ†</button>
        <button class="tab-btn" data-sort="assists">ØµÙ†Ø§Ø¹ Ø§Ù„Ù„Ø¹Ø¨</button>
        <button class="tab-btn" data-sort="saves">Ø§Ù„Ø­Ø±Ø§Ø³</button>
    </div>

    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø±ÙƒØ²</th>
                    <th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th>
                    <th>Ø§Ù„ÙÙˆØ±Ù…Ø©</th>
                    <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                    <th>Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</th>
                    <th>Ø§Ù„Ø£Ø³ÙŠØ³Øª</th>
                    <th>Ø§Ù„ØªØµØ¯ÙŠØ§Øª</th>
                    <th>Ø´Ø¨Ø§Ùƒ Ù†Ø¸ÙŠÙØ©</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                {% for player in players %}
                <tr data-points="{{ player.total_points }}" data-goals="{{ player.total_goals }}"
                    data-assists="{{ player.total_assists }}" data-saves="{{ player.total_saves }}">
                    <td data-label="Ø§Ù„Ù…Ø±ÙƒØ²" class="rank-col">
                        <span class="trend-indicator" style="margin-left: 5px;">
                            {% if player.previous_rank == 0 or player.previous_rank == loop.index %}
                            <span style="color: grey; font-size:0.8rem;">â–</span>
                            {% elif loop.index < player.previous_rank %} <span
                                style="color: var(--positive-color); font-size:0.8rem;"
                                title="ØµØ¹Ø¯ {{ player.previous_rank - loop.index }} Ù…Ø±ÙƒØ²">â¬†ï¸</span>
                        {% else %}
                        <span style="color: var(--negative-color); font-size:0.8rem;"
                            title="ØªØ±Ø§Ø¬Ø¹ {{ loop.index - player.previous_rank }} Ù…Ø±ÙƒØ²">â¬‡ï¸</span>
                        {% endif %}
                        </span>
                        {{ loop.index }}
                        {% if loop.index == 1 %}ğŸ¥‡{% elif loop.index == 2 %}ğŸ¥ˆ{% elif loop.index == 3 %}ğŸ¥‰{% endif %}
                    </td>
                    <td data-label="Ø§Ù„Ù„Ø§Ø¹Ø¨">
                        <a href="/player/{{ player.id }}"
                            style="text-decoration: none; color: inherit; font-weight: bold;">{{ player.name }}</a>
                        {% if loop.index == 1 %}<span class="crown">ğŸ‘‘</span>{% endif %}
                    </td>
                    <td data-label="Ø§Ù„ÙÙˆØ±Ù…Ø©">{{ player.form }}</td>
                    <td data-label="Ø§Ù„Ù†Ù‚Ø§Ø·"><strong>{{ player.total_points }}</strong></td>
                    <td data-label="Ø§Ù„Ø£Ù‡Ø¯Ø§Ù">{{ player.total_goals }}</td>
                    <td data-label="Ø§Ù„Ø£Ø³ÙŠØ³Øª">{{ player.total_assists }}</td>
                    <td data-label="Ø§Ù„ØªØµØ¯ÙŠØ§Øª">{{ player.total_saves }}</td>
                    <td data-label="Ø´Ø¨Ø§Ùƒ Ù†Ø¸ÙŠÙØ©">{{ player.total_clean_sheets }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div> <!-- End capture-area -->

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tabs = document.querySelectorAll(".tab-btn");
        const tbody = document.getElementById("leaderboard-body");

        tabs.forEach(tab => {
            tab.addEventListener("click", () => {
                // Update active state
                tabs.forEach(t => t.classList.remove("active"));
                tab.classList.add("active");

                // Get sort metric
                const sortMetric = tab.getAttribute("data-sort");

                // Sort rows
                const rows = Array.from(tbody.querySelectorAll("tr"));
                rows.sort((a, b) => {
                    const valA = parseInt(a.getAttribute(`data-${sortMetric}`)) || 0;
                    const valB = parseInt(b.getAttribute(`data-${sortMetric}`)) || 0;
                    // If sorting by metric is tied, sort by points implicitly (optional fallback)
                    if (valB === valA && sortMetric !== 'points') {
                        const pointsA = parseInt(a.getAttribute('data-points')) || 0;
                        const pointsB = parseInt(b.getAttribute('data-points')) || 0;
                        return pointsB - pointsA;
                    }
                    return valB - valA;
                });

                // Re-append sorted rows and update ranks dynamically
                tbody.innerHTML = "";
                rows.forEach((row, index) => {
                    const rankText = index + 1;
                    const rankPrefix = rankText === 1 ? 'ğŸ¥‡' : rankText === 2 ? 'ğŸ¥ˆ' : rankText === 3 ? 'ğŸ¥‰' : '';

                    // Update the visible rank column
                    const rankCell = row.querySelector(".rank-col");
                    if (rankCell) {
                        rankCell.innerHTML = `${rankText} ${rankPrefix}`;
                    }

                    // Keep the crown logic only for the first row
                    const nameLink = row.querySelector("td[data-label='Ø§Ù„Ù„Ø§Ø¹Ø¨']");
                    if (nameLink) {
                        const existingCrown = nameLink.querySelector(".crown");
                        if (existingCrown) existingCrown.remove();
                        if (rankText === 1 && sortMetric === 'points') {
                            nameLink.insertAdjacentHTML('beforeend', '<span class="crown">ğŸ‘‘</span>');
                        }
                    }

                    tbody.appendChild(row);
                });
            });
        });
    });
</script>
{% endblock %}