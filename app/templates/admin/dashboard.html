{% extends "base.html" %}

{% block content %}
<h1>๐ ุชุณุฌูู ูุชูุฌุฉ ูุจุงุฑุงุฉ (ุงูููุญุฉ ุงูุชูุชูููุฉ)</h1>

<div class="card mb-2" style="border-right: 5px solid var(--warning-color);">
    <h3 style="color: var(--warning-color);">๐ ุฅุฏุงุฑุฉ ุงููุฃุณ</h3>
    <form action="/l/{{ league.slug }}/admin/cup/generate" method="POST">
        <button type="submit" class="btn" style="background-color: var(--warning-color); color: white;">
            ุฅูุดุงุก ูุฑุนุฉ ุงููุฃุณ (ุฃุนูู 10 ูุงุนุจูู)
        </button>
    </form>
    <p class="text-muted mt-1" style="font-size: 0.9rem;">* ุณูุชู ุงุฎุชูุงุฑ ุฃูุถู 10 ูุงุนุจูู ูู ุงูุชุฑุชูุจ ุงูุญุงูู ูุชุณููููู ูู
        ููุงุฌูุงุช
        ุฑุจุน ุงูููุงุฆู.</p>
</div>

<div class="card mb-2" style="border-right: 5px solid var(--danger-color);">
    <h3 style="color: var(--danger-color);">๐จ ุฅููุงุก ุงูุดูุฑ ุงูุญุงูู</h3>
    <form action="/l/{{ league.slug }}/admin/season/end" method="POST"
        onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅููุงุก ุงูุดูุฑุ ุณูุชู ุฅุถุงูุฉ ุงููุชุตุฏุฑ ุฅูู ููุญุฉ ุงูุดุฑู ูุชุตููุฑ ุฌููุน ุงูููุงุท ุงูุญุงููุฉ!');">
        <input type="text" name="month_name" placeholder="ุงุณู ุงูุดูุฑ (ูุซุงู: ุฃุบุณุทุณ 2026)" required class="form-control"
            style="width: 250px; display: inline-block; margin-inline-end: 1rem;">
        <button type="submit" class="btn btn-danger">
            ุฅููุงุก ุงูุดูุฑ ูุงูุฃุฑุดูุฉ
        </button>
    </form>
</div>

<div class="card match-form-container">
    <div style="margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px;">
        <h3 style="margin-top:0;">ุชุฃููุฏ ุงูุฅุฏุงุฑุฉ</h3>
        <input type="password" id="admin_password" placeholder="ุฃุฏุฎู ูููุฉ ุณุฑ ุฅุฏุงุฑุฉ ุงูุฏูุฑู ูุญูุธ ุงููุจุงุฑุงุฉ" required
            class="form-control">
    </div>

    <!-- Tactical Board -->
    <div class="tactical-board" style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px;">

        <!-- Team A -->
        <div class="team-container team-a-container">
            <input type="text" id="team_a_name" value="ูุฑูู ุฃ" class="form-control text-center mb-1"
                style="font-size: 1.5rem; font-weight: bold; border-bottom: 2px solid var(--primary-color);">
            <button id="add-player-a-btn" class="btn btn-primary mb-1" style="width: 100%;">+ ุฅุถุงูุฉ ูุงุนุจ ูููุฑูู</button>
            <div class="table-responsive" style="margin-bottom: 0;">
                <table style="min-width: 700px;">
                    <thead>
                        <tr>
                            <th style="min-width: 120px;">ุงุณู ุงููุงุนุจ</th>
                            <th>โฝ ุฃูุฏุงู</th>
                            <th>๐ ุฃุณูุณุช</th>
                            <th>๐งค ุญุงุฑุณุ</th>
                            <th>โ ุชุตุฏูุงุช</th>
                            <th>โ ุนููู</th>
                            <th>๐ก๏ธ CS</th>
                            <th>โญ MVP</th>
                            <th>ยฉ๏ธ ูุงุจุชู</th>
                            <th>ุชุจุฏูู/ุญุฐู</th>
                        </tr>
                    </thead>
                    <tbody id="team-a-body">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Team B -->
        <div class="team-container team-b-container">
            <input type="text" id="team_b_name" value="ูุฑูู ุจ" class="form-control text-center mb-1"
                style="font-size: 1.5rem; font-weight: bold; border-bottom: 2px solid var(--warning-color);">
            <button id="add-player-b-btn" class="btn mb-1"
                style="width: 100%; background: var(--warning-color); color: white;">+ ุฅุถุงูุฉ ูุงุนุจ ูููุฑูู</button>
            <div class="table-responsive" style="margin-bottom: 0;">
                <table style="min-width: 700px;">
                    <thead>
                        <tr>
                            <th style="min-width: 120px;">ุงุณู ุงููุงุนุจ</th>
                            <th>โฝ ุฃูุฏุงู</th>
                            <th>๐ ุฃุณูุณุช</th>
                            <th>๐งค ุญุงุฑุณุ</th>
                            <th>โ ุชุตุฏูุงุช</th>
                            <th>โ ุนููู</th>
                            <th>๐ก๏ธ CS</th>
                            <th>โญ MVP</th>
                            <th>ยฉ๏ธ ูุงุจุชู</th>
                            <th>ุชุจุฏูู/ุญุฐู</th>
                        </tr>
                    </thead>
                    <tbody id="team-b-body">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <button id="save-match-btn" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 1.2rem;">๐พ ุญูุธ
        ุงููุจุงุฑุงุฉ ูุฅูุฑุงุฑ
        ุงููุชูุฌุฉ</button>
</div>

<!-- New Section: League Settings -->
<div class="card mb-4" style="border-right: 5px solid var(--primary-color);">
    <h3 style="color: var(--heading-color);">โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุฏูุฑู</h3>
    <form action="/l/{{ league.slug }}/admin/settings/update" method="POST">
        <div class="form-group mb-1">
            <label>ุงุณู ุงูุฏูุฑู ุงูุฌุฏูุฏ (ุงุฎุชูุงุฑู)</label>
            <input type="text" name="name" class="form-control" placeholder="{{ league.name }}">
        </div>
        <div class="form-group mb-1">
            <label>ุงูุฑุงุจุท (Slug) ุงูุฌุฏูุฏ (ุงุฎุชูุงุฑู)</label>
            <input type="text" name="new_slug" class="form-control" value="{{ league.slug }}">
        </div>
        <div class="form-group mb-1">
            <label>ูููุฉ ุงูุณุฑ ุงูุฌุฏูุฏุฉ (ุงุฎุชูุงุฑู)</label>
            <input type="password" name="new_password" class="form-control"
                placeholder="ุฃุฏุฎู ูููุฉ ุณุฑ ุฌุฏูุฏุฉ ุฅุฐุง ุฃุฑุฏุช ุชุบููุฑูุง">
        </div>
        <div class="form-group mb-2">
            <label style="color: var(--danger-color); font-weight: bold;">ูููุฉ ุงูุณุฑ ุงูุญุงููุฉ (ูุทููุจ ููุญูุธ) *</label>
            <input type="password" name="current_admin_password" class="form-control" required
                placeholder="ูุฌุจ ุฅุฏุฎุงู ูููุฉ ุงูุณุฑ ุงูุญุงููุฉ ูุชุฃููุฏ ุงููููุฉ">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">ุญูุธ ุงูุชุนุฏููุงุช ุงูุดุงููุฉ</button>
    </form>
</div>

<!-- Danger Zone -->
<div class="card mb-4" style="border: 2px solid var(--danger-color); background: rgba(231, 76, 60, 0.05);">
    <h3 style="color: var(--danger-color);">โ๏ธ ููุทูุฉ ุงูุฎุทุฑ (Danger Zone)</h3>
    <p class="text-secondary mb-2">ุญุฐู ุงูุฏูุฑู ุณูุคุฏู ุฅูู ูุณุญ ุฌููุน ุงููุงุนุจููุ ุงููุจุงุฑูุงุชุ ูุงูุฅุญุตุงุฆูุงุช ูุชุงุฑูุฎ ุงููุฃุณ ุงูุฎุงุต
        ุจุงูุฏูุฑู ููุงุฆูุงู. ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก ุชุญุช ุฃู ุธุฑู.</p>
    <button type="button" class="btn delete-league-btn" data-league-slug="{{ league.slug }}"
        style="background-color: var(--danger-color); color: white; width: 100%;">
        ๐๏ธ ุญุฐู ุงูุฏูุฑู ููุงุฆูุงู
    </button>
</div>

<!-- Template for a new row (hidden) -->
<template id="player-row-template">
    <tr class="player-row">
        <td data-label="ุงูุงุณู">
            <input type="text" class="player-name-input form-control" placeholder="ุงุณู ุงููุงุนุจ">
        </td>
        <td data-label="ุฃูุฏุงู">
            <input type="number" class="goals-input form-control" value="0" min="0"
                style="min-width: 50px; padding: 5px;">
        </td>
        <td data-label="ุฃุณูุณุช">
            <input type="number" class="assists-input form-control" value="0" min="0"
                style="min-width: 50px; padding: 5px;">
        </td>
        <td data-label="ุญุงุฑุณุ">
            <input type="checkbox" class="is-gk-check">
        </td>
        <td data-label="ุชุตุฏูุงุช">
            <input type="number" class="saves-input form-control" value="0" min="0" disabled
                style="min-width: 50px; padding: 5px; opacity: 0.5;">
        </td>
        <td data-label="ุฃูุฏุงู ุนููู">
            <input type="number" class="conceded-input form-control" value="0" min="0"
                style="min-width: 50px; padding: 5px;">
        </td>
        <td data-label="CS">
            <input type="checkbox" class="clean-sheet-check">
        </td>
        <td data-label="MVP">
            <input type="checkbox" class="mvp-check">
        </td>
        <td data-label="ูุงุจุชู (x2)">
            <input type="checkbox" class="captain-check">
        </td>
        <td data-label="ุงูุฅุฌุฑุงุก" style="white-space: nowrap;">
            <button class="swap-row-btn" title="ุงููู ุงููุงุนุจ ูููุฑูู ุงูุขุฎุฑ"
                style="background-color: var(--primary-color); color: white; border: none; padding: 5px 10px; border-radius: var(--radius-sm); cursor: pointer; margin-inline-start: 5px;">๐</button>
            <button class="remove-row-btn" title="ุญุฐู"
                style="background-color: var(--danger-color); color: white; border: none; padding: 5px 10px; border-radius: var(--radius-sm); cursor: pointer;">X</button>
        </td>
    </tr>
</template>

<script>
    const teamABody = document.getElementById('team-a-body');
    const teamBBody = document.getElementById('team-b-body');
    const template = document.getElementById('player-row-template');

    // Function to add a new row
    function addPlayerRow(targetBody) {
        const clone = template.content.cloneNode(true);
        const tr = clone.querySelector('tr');

        // Remove
        clone.querySelector('.remove-row-btn').addEventListener('click', function () {
            this.closest('tr').remove();
        });

        // Swap
        clone.querySelector('.swap-row-btn').addEventListener('click', function () {
            const currentRow = this.closest('tr');
            if (currentRow.parentElement.id === 'team-a-body') {
                teamBBody.appendChild(currentRow);
            } else {
                teamABody.appendChild(currentRow);
            }
        });

        // GK logic
        const gkCheck = clone.querySelector('.is-gk-check');
        const savesInput = clone.querySelector('.saves-input');

        gkCheck.addEventListener('change', function () {
            savesInput.disabled = !this.checked;
            if (this.checked) {
                savesInput.style.backgroundColor = 'white';
                savesInput.focus();
            } else {
                savesInput.style.backgroundColor = '#f0f0f0';
                savesInput.value = 0;
            }
        });

        targetBody.appendChild(clone);
    }

    // Add 5 initial rows for each team
    for (let i = 0; i < 5; i++) {
        addPlayerRow(teamABody);
        addPlayerRow(teamBBody);
    }

    document.getElementById('add-player-a-btn').addEventListener('click', () => addPlayerRow(teamABody));
    document.getElementById('add-player-b-btn').addEventListener('click', () => addPlayerRow(teamBBody));

    document.getElementById('save-match-btn').addEventListener('click', async () => {
        const adminPassword = document.getElementById('admin_password').value;
        if (!adminPassword) {
            alert('โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ุณุฑ ุงูุฅุฏุงุฑุฉ ุงูุฎุงุต ุจุงูุฏูุฑู.');
            return;
        }

        const teamAName = document.getElementById('team_a_name').value.trim() || 'ูุฑูู ุฃ';
        const teamBName = document.getElementById('team_b_name').value.trim() || 'ูุฑูู ุจ';
        const stats = [];

        // Parse Team A
        const rowsA = teamABody.querySelectorAll('.player-row');
        rowsA.forEach(row => collectRowStats(row, 'A', stats));

        // Parse Team B
        const rowsB = teamBBody.querySelectorAll('.player-row');
        rowsB.forEach(row => collectRowStats(row, 'B', stats));

        if (stats.length === 0) {
            alert('โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ุจูุงูุงุช ูุงุนุจ ูุงุญุฏ ุนูู ุงูุฃูู.');
            return;
        }

        const payload = {
            team_a_name: teamAName,
            team_b_name: teamBName,
            stats: stats,
            admin_password: adminPassword
        };

        try {
            const response = await fetch('/l/{{ league.slug }}/admin/match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert('โ ุชู ุญูุธ ุงููุจุงุฑุงุฉ ุจูุฌุงุญ ูุฅุญุชุณุงุจ ุงูููุงุท ุชููุงุฆูุงู ููู ูุฑูู!');
                window.location.reload();
            } else {
                const errorData = await response.json();
                alert('โ ุญุฏุซ ุฎุทุฃ: ' + (errorData.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('โ ุชุนุฐุฑ ุงูุงุชุตุงู ุจุงูุฎุงุฏู.');
        }
    });

    function collectRowStats(row, teamIdentifier, statsArray) {
        const nameInput = row.querySelector('.player-name-input');
        const name = nameInput.value.trim();

        if (name) {
            statsArray.push({
                player_name: name,
                team: teamIdentifier,
                goals: parseInt(row.querySelector('.goals-input').value) || 0,
                assists: parseInt(row.querySelector('.assists-input').value) || 0,
                saves: parseInt(row.querySelector('.saves-input').value) || 0,
                goals_conceded: parseInt(row.querySelector('.conceded-input').value) || 0,
                is_gk: row.querySelector('.is-gk-check').checked,
                clean_sheet: row.querySelector('.clean-sheet-check').checked,
                mvp: row.querySelector('.mvp-check').checked,
                is_captain: row.querySelector('.captain-check').checked
            });
        }
    }

    // Delete League Logic
    document.querySelector('.delete-league-btn').addEventListener('click', async function () {
        const slug = this.getAttribute('data-league-slug');
        const password = await showPromptModal("ุญุฐู ุงูุฏูุฑู ููุงุฆูุงู", "ุฃุฏุฎู ูููุฉ ูุฑูุฑ ุงูุขุฏูู ูุชุฃููุฏ ุงูุญุฐู ุงูููุงุฆู ููุง ูููู ุงูุชุฑุงุฌุน ุนู ุฐูู:");
        if (!password) return;

        try {
            const formData = new FormData();
            formData.append('admin_password', password);

            const response = await fetch(`/l/${slug}/admin/settings/delete`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success && result.redirect_url) {
                showToast('ุชู ุญุฐู ุงูุฏูุฑู ุจูุฌุงุญ. ุฌุงุฑู ุงูุชูุฌูู...', 'success');
                setTimeout(() => window.location.href = result.redirect_url, 1500);
            } else {
                showToast(result.detail || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู.', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุงูุฎุงุฏู.', 'error');
        }
    });

</script>
{% endblock %}