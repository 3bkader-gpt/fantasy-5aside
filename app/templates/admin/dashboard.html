{% extends "base.html" %}

{% block content %}
<h1>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ù…Ø¨Ø§Ø±Ø§Ø© (Ù„Ù„Ù…Ø­ØªØ±ÙÙŠÙ†)</h1>

<div class="admin-actions"
    style="margin-bottom: 30px; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h3>ğŸ† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ£Ø³</h3>
    <form action="/l/{{ league.slug }}/admin/cup/generate" method="POST">
        <button type="submit" class="btn-primary"
            style="background-color: #f39c12; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
            Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø±Ø¹Ø© Ø§Ù„ÙƒØ£Ø³ (Ø£Ø¹Ù„Ù‰ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ†)
        </button>
    </form>
    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">* Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØªØ³ÙƒÙŠÙ†Ù‡Ù…
        ÙÙŠ Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø±Ø¨Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.</p>
</div>

<div class="admin-actions"
    style="margin-bottom: 30px; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #e74c3c;">
    <h3 style="color: #e74c3c;">ğŸš¨ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
    <form action="/l/{{ league.slug }}/admin/season/end" method="POST"
        onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ØŸ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØµØ¯Ø± Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù ÙˆØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©!');">
        <input type="text" name="month_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø± (Ù…Ø«Ø§Ù„: Ø£ØºØ³Ø·Ø³ 2026)" required
            style="padding: 10px; width: 250px; border: 1px solid #ccc; border-radius: 5px; margin-left: 10px;">
        <button type="submit" class="btn-primary"
            style="background-color: #e74c3c; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
            Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©
        </button>
    </form>
</div>

<div class="match-form">
    <h3>ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¯ÙˆØ±ÙŠ (Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©)</h3>
    <input type="password" id="admin_password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠ" required
        style="padding: 10px; width: 100%; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 20px;">

    <button id="add-player-btn" class="btn-primary"
        style="margin-bottom: 20px; width: auto; background-color: #3498db;">+ Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>

    <div class="table-responsive">
        <table id="match-table">
            <thead>
                <tr>
                    <th style="min-width: 150px;">Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨</th>
                    <th>Ø£Ù‡Ø¯Ø§Ù</th>
                    <th>Ø£Ø³ÙŠØ³Øª</th>
                    <th>Ø­Ø§Ø±Ø³ØŸ</th>
                    <th>ØªØµØ¯ÙŠØ§Øª</th>
                    <th>Ø£Ù‡Ø¯Ø§Ù Ø¹Ù„ÙŠÙ‡</th>
                    <th>ÙØ§Ø¦Ø²ØŸ</th>
                    <th>CS</th>
                    <th>MVP</th>
                    <th>ÙƒØ§Ø¨ØªÙ† (x2)</th>
                    <th>Ø­Ø°Ù</th>
                </tr>
            </thead>
            <tbody id="match-table-body">
                <!-- Rows will be added dynamically here -->
            </tbody>
        </table>
    </div>

    <button id="save-match-btn" class="btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</button>
</div>

<!-- Template for a new row (hidden) -->
<template id="player-row-template">
    <tr class="player-row">
        <td data-label="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
            <input type="text" class="player-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨"
                style="width: 100%; text-align: right; padding: 5px;">
        </td>

        <td data-label="Ø£Ù‡Ø¯Ø§Ù">
            <input type="number" class="goals-input" value="0" min="0">
        </td>

        <td data-label="Ø£Ø³ÙŠØ³Øª">
            <input type="number" class="assists-input" value="0" min="0">
        </td>

        <td data-label="Ø­Ø§Ø±Ø³ØŸ">
            <input type="checkbox" class="is-gk-check">
        </td>

        <td data-label="ØªØµØ¯ÙŠØ§Øª">
            <input type="number" class="saves-input" value="0" min="0" disabled style="background-color: #f0f0f0;">
        </td>

        <td data-label="Ø£Ù‡Ø¯Ø§Ù Ø¹Ù„ÙŠÙ‡">
            <input type="number" class="conceded-input" value="0" min="0">
        </td>

        <td data-label="ÙØ§Ø¦Ø²ØŸ">
            <input type="checkbox" class="winner-check">
        </td>

        <td data-label="CS">
            <input type="checkbox" class="clean-sheet-check">
        </td>

        <td data-label="MVP">
            <input type="checkbox" class="mvp-check">
        </td>

        <td data-label="ÙƒØ§Ø¨ØªÙ† (x2)">
            <input type="checkbox" class="captain-check">
        </td>

        <td data-label="Ø­Ø°Ù">
            <button class="remove-row-btn"
                style="background-color: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">X</button>
        </td>
    </tr>
</template>

<script>
    const tableBody = document.getElementById('match-table-body');
    const template = document.getElementById('player-row-template');

    // Function to add a new row
    function addPlayerRow() {
        const clone = template.content.cloneNode(true);

        // Add Remove functionality to the new button
        clone.querySelector('.remove-row-btn').addEventListener('click', function () {
            this.closest('tr').remove();
        });

        // Add GK toggle functionality
        const gkCheck = clone.querySelector('.is-gk-check');
        const savesInput = clone.querySelector('.saves-input');

        gkCheck.addEventListener('change', function () {
            savesInput.disabled = !this.checked;
            if (this.checked) {
                savesInput.style.backgroundColor = 'white';
                savesInput.focus();
            } else {
                savesInput.style.backgroundColor = '#f0f0f0';
                savesInput.value = 0;
            }
        });

        tableBody.appendChild(clone);
    }

    // Add 10 initial rows for convenience
    for (let i = 0; i < 10; i++) {
        addPlayerRow();
    }

    document.getElementById('add-player-btn').addEventListener('click', addPlayerRow);

    document.getElementById('save-match-btn').addEventListener('click', async () => {
        const adminPassword = document.getElementById('admin_password').value;
        if (!adminPassword) {
            alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¯ÙˆØ±ÙŠ.');
            return;
        }

        const stats = [];
        const rows = document.querySelectorAll('.player-row');

        rows.forEach(row => {
            const nameInput = row.querySelector('.player-name-input');
            const name = nameInput.value.trim();

            // Only process rows with a name
            if (name) {
                const goals = parseInt(row.querySelector('.goals-input').value) || 0;
                const assists = parseInt(row.querySelector('.assists-input').value) || 0;
                const saves = parseInt(row.querySelector('.saves-input').value) || 0;
                const conceded = parseInt(row.querySelector('.conceded-input').value) || 0;

                const isGk = row.querySelector('.is-gk-check').checked;
                const isWinner = row.querySelector('.winner-check').checked;
                const cleanSheet = row.querySelector('.clean-sheet-check').checked;
                const isMvp = row.querySelector('.mvp-check').checked;
                const isCaptain = row.querySelector('.captain-check').checked;

                stats.push({
                    player_name: name,
                    goals: goals,
                    assists: assists,
                    saves: saves,
                    goals_conceded: conceded,
                    is_gk: isGk,
                    is_winner: isWinner,
                    clean_sheet: cleanSheet,
                    mvp: isMvp,
                    is_captain: isCaptain
                });
            }
        });

        if (stats.length === 0) {
            alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
            return;
        }

        try {
            const response = await fetch('/l/{{ league.slug }}/admin/match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ stats: stats, admin_password: adminPassword })
            });

            if (response.ok) {
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                window.location.reload();
            } else {
                const errorData = await response.json();
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (errorData.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
        }
    });
</script>
{% endblock %}